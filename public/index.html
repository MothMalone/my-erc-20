<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Management - TranMinhNam23021646</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wallet-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .wallet-info h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .info-label {
            font-weight: bold;
            color: #555;
        }

        .info-value {
            color: #333;
            font-family: monospace;
            word-break: break-all;
        }

        .connect-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
            display: block;
            margin: 20px auto;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .connect-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .approve-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .approve-section h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            font-family: monospace;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .approved-list {
            margin-top: 30px;
        }

        .approved-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #27ae60;
        }

        .approved-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .approved-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .approved-address {
            font-family: monospace;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .approved-amount {
            color: #27ae60;
            font-size: 1.1em;
            font-weight: bold;
        }

        .transaction {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            transition: transform 0.2s;
        }

        .transaction:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .transaction.sent {
            border-left-color: #e74c3c;
        }

        .transaction.received {
            border-left-color: #27ae60;
        }

        .transaction.approved {
            border-left-color: #f39c12;
        }

        .tx-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .tx-type {
            font-weight: bold;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .tx-type.sent {
            background: #ffebee;
            color: #e74c3c;
        }

        .tx-type.received {
            background: #e8f5e9;
            color: #27ae60;
        }

        .tx-type.approved {
            background: #fff3cd;
            color: #f39c12;
        }

        .tx-amount {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .tx-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        .tx-details div {
            margin-bottom: 5px;
        }

        .tx-hash {
            font-family: monospace;
            font-size: 0.85em;
            color: #667eea;
            cursor: pointer;
        }

        .tx-hash:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .tx-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .tx-note {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
            border-left: 3px solid #ffc107;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 0.85em;
            border-radius: 5px;
        }

        .tx-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        /* NFT Styles */
        .nft-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .nft-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .nft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .nft-image {
            width: 100%;
            height: 280px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .nft-info {
            padding: 15px;
        }

        .nft-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .nft-description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .nft-token-id {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .nft-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .nft-actions .btn {
            flex: 1;
            padding: 8px 15px;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü™ô Qu·∫£n L√Ω Token TMN</h1>
            <p>TranMinhNam23021646 Token - ERC20</p>
        </div>

        <div class="content">
            <div id="walletSection">
                <button class="connect-btn" id="connectBtn">K·∫øt n·ªëi MetaMask</button>
            </div>

            <div id="mainSection" style="display: none;">
                <div class="wallet-info">
                    <h2>üìä Th√¥ng tin t√†i kho·∫£n</h2>
                    <div class="info-row">
                        <span class="info-label">ƒê·ªãa ch·ªâ v√≠:</span>
                        <span class="info-value" id="walletAddress">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Network:</span>
                        <span class="info-value" id="networkName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">S·ªë d∆∞ ETH:</span>
                        <span class="info-value" id="ethBalance">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">S·ªë d∆∞ TMN:</span>
                        <span class="info-value" id="tokenBalance">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Contract Address:</span>
                        <span class="info-value" id="contractAddress">-</span>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" data-tab="buy">üí∞ Mua Token</button>
                    <button class="tab" data-tab="approve">üîê Ph√™ duy·ªát (Approve)</button>
                    <button class="tab" data-tab="history">üìú L·ªãch s·ª≠ giao d·ªãch</button>
                    <button class="tab" data-tab="approved-list">üìã Danh s√°ch ƒë√£ ph√™ duy·ªát</button>
                    <button class="tab" data-tab="nft">üé® NFT Collection</button>
                </div>

                <!-- Buy Token Tab -->
                <div id="tab-buy" class="tab-content active">
                    <div class="approve-section">
                        <h3>üí∞ Mua TMN Token b·∫±ng ETH</h3>
                        <p style="margin-bottom: 20px; color: #666;">
                            G·ª≠i ETH ƒë·ªÉ mua TMN token theo t·ª∑ gi√° hi·ªán t·∫°i
                        </p>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; color: #1976d2;">üìä Th√¥ng tin gi√°</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">T·ª∑ gi√° hi·ªán t·∫°i:</div>
                                    <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;" id="tokenPrice">
                                        ƒêang t·∫£i...
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">T·ªïng ETH ƒë√£ b√°n:</div>
                                    <div style="font-size: 1.3em; font-weight: bold; color: #27ae60;" id="totalEthRaised">
                                        ƒêang t·∫£i...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>üíµ S·ªë l∆∞·ª£ng ETH mu·ªën g·ª≠i:</label>
                            <input type="number" step="0.001" class="form-input" id="buyEthAmount" placeholder="VD: 0.01">
                            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                                B·∫°n s·∫Ω nh·∫≠n: <span id="estimatedTokens" style="font-weight: bold; color: #667eea;">0 TMN</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>ü™ô Ho·∫∑c nh·∫≠p s·ªë TMN mu·ªën mua:</label>
                            <input type="number" class="form-input" id="buyTokenAmount" placeholder="VD: 1000">
                            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                                Chi ph√≠: <span id="estimatedEth" style="font-weight: bold; color: #667eea;">0 ETH</span>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-success" id="buyTokenBtn">üõí Mua Token</button>
                        </div>

                        <div id="buyMessage" style="margin-top: 20px;"></div>

                        <!-- Owner controls (ch·ªâ hi·ªán khi user l√† owner) -->
                        <div id="ownerControls" style="display: none; margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 10px;">
                            <h4 style="color: #856404; margin-bottom: 15px;">‚öôÔ∏è Qu·∫£n l√Ω (Ch·ªâ Owner)</h4>
                            
                            <div class="form-group">
                                <label>üí≤ ƒê·∫∑t gi√° m·ªõi (1 ETH = ? TMN):</label>
                                <input type="number" class="form-input" id="newPrice" placeholder="VD: 2000">
                            </div>
                            <button class="btn" id="setPriceBtn" style="background: #ffc107; color: #000;">C·∫≠p nh·∫≠t gi√°</button>
                            
                            <button class="btn btn-danger" id="withdrawEthBtn" style="margin-top: 15px;">
                                üí∏ R√∫t ETH v·ªÅ v√≠ Owner
                            </button>
                        </div>
                    </div>
                </div>

                <div id="tab-approve" class="tab-content"
                    <div class="approve-section">
                        <h3>üîê Ph√™ duy·ªát ƒë·ªãa ch·ªâ chi ti√™u token</h3>
                        <p style="margin-bottom: 20px; color: #666;">
                            Cho ph√©p m·ªôt ƒë·ªãa ch·ªâ kh√°c ƒë∆∞·ª£c quy·ªÅn chi ti√™u token c·ªßa b·∫°n (d√πng cho transferFrom)
                        </p>
                        
                        <div class="form-group">
                            <label>üìù T√™n g·ª£i nh·ªõ (nickname):</label>
                            <input type="text" class="form-input" id="approveName" placeholder="VD: V√≠ c·ªßa b·∫°n An">
                        </div>

                        <div class="form-group">
                            <label>üìç ƒê·ªãa ch·ªâ ƒë∆∞·ª£c ph√™ duy·ªát:</label>
                            <input type="text" class="form-input" id="approveAddress" placeholder="0x...">
                        </div>

                        <div class="form-group">
                            <label>üí∞ S·ªë l∆∞·ª£ng token cho ph√©p:</label>
                            <input type="number" class="form-input" id="approveAmount" placeholder="VD: 1000">
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-success" id="approveBtn">‚úÖ Ph√™ duy·ªát</button>
                            <button class="btn btn-danger" id="revokeBtn">‚ùå Thu h·ªìi ph√™ duy·ªát</button>
                        </div>

                        <div id="approveMessage" style="margin-top: 20px;"></div>
                        
                        <!-- Transfer tr·ª±c ti·∫øp t·ª´ v√≠ hi·ªán t·∫°i -->
                        <hr style="margin:20px 0;" />
                        <h4>üëâ G·ª≠i TMN (transfer)</h4>
                        <div class="form-group">
                            <label>üìç ƒê·∫øn (to):</label>
                            <input type="text" class="form-input" id="transferTo" placeholder="0x...">
                        </div>
                        <div class="form-group">
                            <label>üí∞ S·ªë l∆∞·ª£ng TMN:</label>
                            <input type="number" class="form-input" id="transferAmount" placeholder="VD: 100">
                        </div>
                        <div class="btn-group" style="margin-bottom: 10px;">
                            <button class="btn btn-primary" id="transferBtn">üöÄ G·ª≠i</button>
                        </div>

                        <!-- TransferFrom: current account acts as spender -->
                        <hr style="margin:20px 0;" />
                        <h4>üîÅ TransferFrom (d√πng allowance)</h4>
                        <div class="form-group">
                            <label>üßæ T·ª´ (owner):</label>
                            <input type="text" class="form-input" id="tfFrom" placeholder="ƒê·ªãa ch·ªâ ch·ªß s·ªü h·ªØu (owner)">
                        </div>
                        <div class="form-group">
                            <label>üìç ƒê·∫øn (to):</label>
                            <input type="text" class="form-input" id="tfTo" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n">
                        </div>
                        <div class="form-group">
                            <label>üí∞ S·ªë l∆∞·ª£ng TMN:</label>
                            <input type="number" class="form-input" id="tfAmount" placeholder="VD: 50">
                        </div>
                        <div class="btn-group" style="margin-bottom: 10px;">
                            <button class="btn btn-primary" id="transferFromBtn">üîÅ Th·ª±c hi·ªán transferFrom</button>
                        </div>
                    </div>
                </div>

                <div id="tab-history" class="tab-content">
                    <div class="search-box">
                        <input type="text" class="form-input" id="searchAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·ªÉ tra c·ª©u (ƒë·ªÉ tr·ªëng = v√≠ hi·ªán t·∫°i)">
                        <button class="btn" id="searchBtn">üîç Tra c·ª©u</button>
                    </div>

                    <div class="btn-group" style="margin-bottom: 20px;">
                        <button class="btn" onclick="filterByTag()">üè∑Ô∏è L·ªçc theo tag</button>
                        <button class="btn" onclick="document.getElementById('searchBtn').click()">üîÑ Hi·ªÉn th·ªã t·∫•t c·∫£</button>
                        <button class="btn" onclick="exportHistory()">üì• Xu·∫•t CSV</button>
                    </div>

                    <div id="statsSection" style="display: none;" class="stats">
                        <div class="stat-card">
                            <h4>T·ªïng giao d·ªãch</h4>
                            <div class="value" id="totalTx">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>ƒê√£ g·ª≠i</h4>
                            <div class="value" id="sentTx">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>ƒê√£ nh·∫≠n</h4>
                            <div class="value" id="receivedTx">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>ƒê√£ ph√™ duy·ªát</h4>
                            <div class="value" id="approvedTx">0</div>
                        </div>
                    </div>

                    <div id="historyContent">
                        <div class="no-data">
                            Nh·∫•n "Tra c·ª©u" ƒë·ªÉ xem l·ªãch s·ª≠ giao d·ªãch
                        </div>
                    </div>
                </div>

                <div id="tab-approved-list" class="tab-content">
                    <h3 style="margin-bottom: 20px;">üìã Danh s√°ch ƒë·ªãa ch·ªâ ƒë√£ ph√™ duy·ªát</h3>
                    <div id="approvedListContent">
                        <div class="no-data">
                            Ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o ƒë∆∞·ª£c ph√™ duy·ªát
                        </div>
                    </div>
                </div>

                <!-- NFT Tab -->
                <div id="tab-nft" class="tab-content">
                    <div class="approve-section">
                        <h3>üé® NFT Collection Manager</h3>
                        <p style="margin-bottom: 20px; color: #666;">
                            Mint, view, and transfer your NFTs
                        </p>
                        
                        <!-- NFT Contract Info -->
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; color: #1976d2;">üìä NFT Contract Info</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">Contract Name:</div>
                                    <div style="font-size: 1.1em; font-weight: bold; color: #1976d2;" id="nftContractName">
                                        -
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">Symbol:</div>
                                    <div style="font-size: 1.1em; font-weight: bold; color: #1976d2;" id="nftSymbol">
                                        -
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">Total Supply:</div>
                                    <div style="font-size: 1.1em; font-weight: bold; color: #27ae60;" id="nftTotalSupply">
                                        -
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">Your NFTs:</div>
                                    <div style="font-size: 1.1em; font-weight: bold; color: #27ae60;" id="nftUserBalance">
                                        -
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mint NFT Section -->
                        <div style="background: #f0f4ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">üñºÔ∏è Mint New NFT</h4>
                            
                            <div class="form-group">
                                <label>üìù NFT Name:</label>
                                <input type="text" class="form-input" id="nftName" placeholder="VD: My Amazing NFT">
                            </div>
                            
                            <div class="form-group">
                                <label>üìÑ Description:</label>
                                <textarea class="form-input" id="nftDescription" rows="3" placeholder="M√¥ t·∫£ v·ªÅ NFT c·ªßa b·∫°n..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>üë§ Mint to Address (ƒë·ªÉ tr·ªëng = v√≠ hi·ªán t·∫°i):</label>
                                <input type="text" class="form-input" id="nftMintTo" placeholder="0x... ho·∫∑c ƒë·ªÉ tr·ªëng">
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-success" id="mintNFTBtn">üé® Mint NFT</button>
                                <button class="btn" id="refreshNFTBtn">üîÑ Refresh</button>
                            </div>
                            
                            <div id="nftMintMessage" style="margin-top: 15px;"></div>
                        </div>
                        
                        <!-- Transfer NFT Section -->
                        <div style="background: #fff4e6; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="color: #f57c00; margin-bottom: 15px;">üì§ Transfer NFT</h4>
                            
                            <div class="form-group">
                                <label>üé´ Token ID:</label>
                                <input type="number" class="form-input" id="nftTransferTokenId" placeholder="VD: 0">
                            </div>
                            
                            <div class="form-group">
                                <label>üìç To Address:</label>
                                <input type="text" class="form-input" id="nftTransferTo" placeholder="0x...">
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-success" id="transferNFTBtn">üöÄ Transfer NFT</button>
                            </div>
                            
                            <div id="nftTransferMessage" style="margin-top: 15px;"></div>
                        </div>
                        
                        <!-- Import to MetaMask -->
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="color: #2e7d32; margin-bottom: 15px;">üì≤ Import NFT to MetaMask</h4>
                            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                                Nh·∫≠p Token ID c·ªßa NFT b·∫°n mu·ªën import v√†o MetaMask
                            </p>
                            
                            <div class="form-group">
                                <label>üé´ Token ID:</label>
                                <input type="number" class="form-input" id="nftImportTokenId" placeholder="VD: 0">
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-success" id="importNFTBtn">üì• Import to MetaMask</button>
                            </div>
                            
                            <div id="nftImportMessage" style="margin-top: 15px;"></div>
                        </div>
                        
                        <!-- My NFTs Gallery -->
                        <div style="margin-top: 30px;">
                            <h3 style="margin-bottom: 20px;">üñºÔ∏è My NFT Collection</h3>
                            <div id="nftGallery">
                                <div class="no-data">Ch∆∞a c√≥ NFT n√†o</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script>
        // Contract addresses - defined globally for access from all functions
        const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        const NFT_CONTRACT_ADDRESS = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512";

        window.addEventListener('load', () => {
            
            const TOKEN_ABI = [
                "function name() view returns (string)",
                "function symbol() view returns (string)",
                "function balanceOf(address) view returns (uint256)",
                "function transfer(address to, uint256 amount) returns (bool)",
                "function approve(address spender, uint256 amount) returns (bool)",
                "function allowance(address owner, address spender) view returns (uint256)",
                "function transferFrom(address from, address to, uint256 amount) returns (bool)",
                "function buyTokens() payable",
                "function tokenPrice() view returns (uint256)",
                "function totalEthRaised() view returns (uint256)",
                "function calculateTokenAmount(uint256 ethAmount) view returns (uint256)",
                "function calculateEthCost(uint256 tokenAmount) view returns (uint256)",
                "function setTokenPrice(uint256 newPrice)",
                "function withdrawEth()",
                "function owner() view returns (address)",
                "event Transfer(address indexed from, address indexed to, uint256 value)",
                "event Approval(address indexed owner, address indexed spender, uint256 value)",
                "event TokensPurchased(address indexed buyer, uint256 ethAmount, uint256 tokenAmount)"
            ];

            const NFT_ABI = [
                "function name() view returns (string)",
                "function symbol() view returns (string)",
                "function totalSupply() view returns (uint256)",
                "function balanceOf(address owner) view returns (uint256)",
                "function ownerOf(uint256 tokenId) view returns (address)",
                "function tokenURI(uint256 tokenId) view returns (string)",
                "function tokensOfOwner(address owner) view returns (uint256[])",
                "function getMetadata(uint256 tokenId) view returns (tuple(string name, string description, uint256 mintedAt, address minter))",
                "function mintSimpleNFT(address to, string name, string description) returns (uint256)",
                "function safeTransferFrom(address from, address to, uint256 tokenId)",
                "function approve(address to, uint256 tokenId)",
                "function getApproved(uint256 tokenId) view returns (address)",
                "function tokenByIndex(uint256 index) view returns (uint256)",
                "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
                "function supportsInterface(bytes4 interfaceId) view returns (bool)",
                "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)",
                "event NFTMinted(address indexed to, uint256 indexed tokenId, string tokenURI)",
                "event NFTTransferred(address indexed from, address indexed to, uint256 indexed tokenId)"
            ];

            let provider;
            let signer;
            let contract;
            let nftContract;
            let currentAccount;
            let approvedAddresses = {};

            let txMetadata = {}; // L∆∞u notes, tags cho t·ª´ng transaction

            function loadTxMetadata() {
                const stored = localStorage.getItem('txMetadata_' + currentAccount);
                if (stored) {
                    txMetadata = JSON.parse(stored);
                }
            }

            function saveTxMetadata() {
                localStorage.setItem('txMetadata_' + currentAccount, JSON.stringify(txMetadata));
            }

            // Load approved addresses from storage
            function loadApprovedAddresses() {
                const stored = localStorage.getItem('approvedAddresses_' + currentAccount);
                if (stored) {
                    approvedAddresses = JSON.parse(stored);
                }
            }

            function saveApprovedAddresses() {
                localStorage.setItem('approvedAddresses_' + currentAccount, JSON.stringify(approvedAddresses));
            }

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabId = 'tab-' + tab.dataset.tab;
                    document.getElementById(tabId).classList.add('active');

                    if (tab.dataset.tab === 'approved-list') {
                        displayApprovedList();
                    } else if (tab.dataset.tab === 'nft') {
                        // Check if wallet is connected before loading NFT info
                        if (window.nftContract && window.currentAccount) {
                            loadNFTInfo();
                        } else {
                            // Show message that wallet needs to be connected
                            const gallery = document.getElementById('nftGallery');
                            if (gallery) {
                                gallery.innerHTML = '<div class="error">‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi v√≠ ƒë·ªÉ xem NFT collection</div>';
                            }
                        }
                    }
                });
            });

            // Thay th·∫ø ƒëo·∫°n code Connect MetaMask trong file HTML c·ªßa b·∫°n

            // Connect MetaMask - FIXED VERSION
            document.getElementById('connectBtn').addEventListener('click', async () => {
                try {
                    if (typeof window.ethereum === 'undefined') {
                        alert('‚ùå Vui l√≤ng c√†i ƒë·∫∑t MetaMask!');
                        return;
                    }

                    // Request accounts
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    currentAccount = await signer.getAddress();
                    
                    const network = await provider.getNetwork();
                    
                    console.log('Connected to network:', network);
                    console.log('Chain ID:', network.chainId);
                    
                    // FIXED: Check if on Hardhat Local
                    if (network.chainId !== 31337) {
                        // Th·ª≠ t·ª± ƒë·ªông switch network
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x7a69' }], // 31337 in hex
                            });
                            
                            // Reload sau khi switch
                            window.location.reload();
                            return;
                            
                        } catch (switchError) {
                            // Network ch∆∞a ƒë∆∞·ª£c th√™m, th·ª≠ th√™m m·ªõi
                            if (switchError.code === 4902) {
                                try {
                                    await window.ethereum.request({
                                        method: 'wallet_addEthereumChain',
                                        params: [{
                                            chainId: '0x7a69',
                                            chainName: 'Hardhat Local',
                                            nativeCurrency: {
                                                name: 'ETH',
                                                symbol: 'ETH',
                                                decimals: 18
                                            },
                                            rpcUrls: ['http://127.0.0.1:8545'],
                                        }],
                                    });
                                    
                                    // Reload sau khi th√™m
                                    window.location.reload();
                                    return;
                                    
                                } catch (addError) {
                                    alert('‚ùå Kh√¥ng th·ªÉ th√™m network Hardhat Local. Vui l√≤ng th√™m th·ªß c√¥ng!');
                                    return;
                                }
                            }
                            
                            alert('‚ö†Ô∏è Vui l√≤ng chuy·ªÉn sang m·∫°ng Hardhat Local (Chain ID: 31337) th·ªß c√¥ng!');
                            return;
                        }
                    }
                    
                    // Kh·ªüi t·∫°o contracts
                    contract = new ethers.Contract(CONTRACT_ADDRESS, TOKEN_ABI, signer);
                    nftContract = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_ABI, signer);
                    
                    // Make globally accessible for NFT functions
                    window.nftContract = nftContract;
                    window.currentAccount = currentAccount;
                    window.provider = provider;
                    window.signer = signer;
                    
                    // Load data
                    loadApprovedAddresses();
                    loadTxMetadata();
                    await displayWalletInfo();
                    await loadBuyTokenInfo();
                    
                    // Show main section
                    document.getElementById('walletSection').style.display = 'none';
                    document.getElementById('mainSection').style.display = 'block';

                } catch (error) {
                    console.error('Connection error:', error);
                    alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi: ' + error.message);
                }
            });

            // BONUS: Auto-detect network changes
            if (window.ethereum) {
                window.ethereum.on('chainChanged', (chainIdHex) => {
                    console.log('Chain changed to:', chainIdHex);
                    const chainId = parseInt(chainIdHex, 16);
                    
                    if (chainId === 31337) {
                        // ƒê√£ chuy·ªÉn v·ªÅ Hardhat, reload
                        window.location.reload();
                    } else {
                        // Chuy·ªÉn sang network kh√°c, ·∫©n main section
                        if (document.getElementById('mainSection').style.display === 'block') {
                            alert('‚ö†Ô∏è B·∫°n ƒë√£ chuy·ªÉn kh·ªèi Hardhat Local. Vui l√≤ng chuy·ªÉn v·ªÅ ƒë·ªÉ ti·∫øp t·ª•c!');
                            window.location.reload();
                        }
                    }
                });

                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        console.log('Account changed to:', accounts[0]);
                        window.location.reload();
                    } else {
                        // User disconnected
                        document.getElementById('walletSection').style.display = 'block';
                        document.getElementById('mainSection').style.display = 'none';
                    }
                });
            }

            async function displayWalletInfo() {
                try {
                    const ethBalance = await provider.getBalance(currentAccount);
                    const ethFormatted = ethers.utils.formatEther(ethBalance);

                    const network = await provider.getNetwork();
                    const networkName = network.chainId === 31337 ? 'Hardhat Local (localhost:8545)' : network.name;

                    let tokenBalance;
                    let tokenFormatted = 'N/A';
                    try {
                        tokenBalance = await contract.balanceOf(currentAccount);
                        tokenFormatted = ethers.utils.formatEther(tokenBalance);
                    } catch (err) {
                        console.error('Error getting token balance:', err);
                        tokenFormatted = 'Contract kh√¥ng t·ªìn t·∫°i';
                    }

                    document.getElementById('walletAddress').textContent = currentAccount;
                    document.getElementById('networkName').textContent = networkName;
                    document.getElementById('ethBalance').textContent = parseFloat(ethFormatted).toFixed(4) + ' ETH';
                    document.getElementById('tokenBalance').textContent = 
                        typeof tokenFormatted === 'string' && tokenFormatted.includes('kh√¥ng') 
                            ? tokenFormatted 
                            : parseFloat(tokenFormatted).toFixed(2) + ' TMN';
                    document.getElementById('contractAddress').textContent = CONTRACT_ADDRESS;

                } catch (error) {
                    console.error('Error:', error);
                }
            }

            // ========== BUY TOKEN FUNCTIONALITY ==========
            async function loadBuyTokenInfo() {
                try {
                    const price = await contract.tokenPrice();
                    const raised = await contract.totalEthRaised();
                    const contractOwner = await contract.owner();

                    document.getElementById('tokenPrice').textContent = `1 ETH = ${price.toString()} TMN`;
                    document.getElementById('totalEthRaised').textContent = ethers.utils.formatEther(raised) + ' ETH';

                    // Show owner controls if current user is owner
                    if (contractOwner.toLowerCase() === currentAccount.toLowerCase()) {
                        document.getElementById('ownerControls').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading buy info:', error);
                }
            }

            // Calculate tokens when ETH input changes
            document.getElementById('buyEthAmount').addEventListener('input', async (e) => {
                const ethAmount = e.target.value;
                if (!ethAmount || parseFloat(ethAmount) <= 0) {
                    document.getElementById('estimatedTokens').textContent = '0 TMN';
                    return;
                }

                try {
                    const ethWei = ethers.utils.parseEther(ethAmount);
                    const tokenAmount = await contract.calculateTokenAmount(ethWei);
                    const formatted = ethers.utils.formatEther(tokenAmount);
                    document.getElementById('estimatedTokens').textContent = parseFloat(formatted).toFixed(2) + ' TMN';
                } catch (error) {
                    document.getElementById('estimatedTokens').textContent = 'L·ªói t√≠nh to√°n';
                }
            });

            // Calculate ETH when token input changes
            document.getElementById('buyTokenAmount').addEventListener('input', async (e) => {
                const tokenAmount = e.target.value;
                if (!tokenAmount || parseFloat(tokenAmount) <= 0) {
                    document.getElementById('estimatedEth').textContent = '0 ETH';
                    return;
                }

                try {
                    const tokenWei = ethers.utils.parseEther(tokenAmount);
                    const ethCost = await contract.calculateEthCost(tokenWei);
                    const formatted = ethers.utils.formatEther(ethCost);
                    document.getElementById('estimatedEth').textContent = parseFloat(formatted).toFixed(6) + ' ETH';
                } catch (error) {
                    document.getElementById('estimatedEth').textContent = 'L·ªói t√≠nh to√°n';
                }
            });

            // Buy token button
            document.getElementById('buyTokenBtn').addEventListener('click', async () => {
                const ethAmount = document.getElementById('buyEthAmount').value.trim();
                const tokenAmount = document.getElementById('buyTokenAmount').value.trim();
                const messageDiv = document.getElementById('buyMessage');

                let ethToSend;
                
                if (ethAmount && parseFloat(ethAmount) > 0) {
                    ethToSend = ethers.utils.parseEther(ethAmount);
                } else if (tokenAmount && parseFloat(tokenAmount) > 0) {
                    try {
                        const tokenWei = ethers.utils.parseEther(tokenAmount);
                        ethToSend = await contract.calculateEthCost(tokenWei);
                    } catch (error) {
                        messageDiv.innerHTML = '<div class="error">‚ùå L·ªói t√≠nh to√°n chi ph√≠!</div>';
                        return;
                    }
                } else {
                    messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng nh·∫≠p s·ªë ETH ho·∫∑c s·ªë TMN!</div>';
                    return;
                }

                try {
                    messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang g·ª≠i giao d·ªãch mua token...</div>';
                    
                    const tx = await contract.buyTokens({ value: ethToSend });
                    
                    messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang ch·ªù x√°c nh·∫≠n...</div>';
                    const receipt = await tx.wait();

                    // Get event data
                    const event = receipt.events?.find(e => e.event === 'TokensPurchased');
                    const tokensBought = event ? ethers.utils.formatEther(event.args.tokenAmount) : 'N/A';

                    messageDiv.innerHTML = `<div class="success">‚úÖ Mua th√†nh c√¥ng ${parseFloat(tokensBought).toFixed(2)} TMN!</div>`;
                    
                    document.getElementById('buyEthAmount').value = '';
                    document.getElementById('buyTokenAmount').value = '';
                    document.getElementById('estimatedTokens').textContent = '0 TMN';
                    document.getElementById('estimatedEth').textContent = '0 ETH';

                    await displayWalletInfo();
                    await loadBuyTokenInfo();

                } catch (error) {
                    console.error('Buy error:', error);
                    messageDiv.innerHTML = '<div class="error">‚ùå L·ªói: ' + error.message + '</div>';
                }
            });

            // Set price button (owner only)
            document.getElementById('setPriceBtn').addEventListener('click', async () => {
                const newPrice = document.getElementById('newPrice').value.trim();
                const messageDiv = document.getElementById('buyMessage');

                if (!newPrice || parseFloat(newPrice) <= 0) {
                    messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng nh·∫≠p gi√° h·ª£p l·ªá!</div>';
                    return;
                }

                try {
                    messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang c·∫≠p nh·∫≠t gi√°...</div>';
                    
                    const tx = await contract.setTokenPrice(newPrice);
                    await tx.wait();

                    messageDiv.innerHTML = `<div class="success">‚úÖ ƒê√£ c·∫≠p nh·∫≠t gi√°: 1 ETH = ${newPrice} TMN</div>`;
                    document.getElementById('newPrice').value = '';
                    await loadBuyTokenInfo();

                } catch (error) {
                    console.error('Set price error:', error);
                    messageDiv.innerHTML = '<div class="error">‚ùå L·ªói: ' + error.message + '</div>';
                }
            });

            // Withdraw ETH button (owner only)
            document.getElementById('withdrawEthBtn').addEventListener('click', async () => {
                const messageDiv = document.getElementById('buyMessage');

                if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën r√∫t to√†n b·ªô ETH v·ªÅ v√≠?')) return;

                try {
                    messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang r√∫t ETH...</div>';
                    
                    const tx = await contract.withdrawEth();
                    await tx.wait();

                    messageDiv.innerHTML = '<div class="success">‚úÖ ƒê√£ r√∫t ETH th√†nh c√¥ng!</div>';
                    await displayWalletInfo();
                    await loadBuyTokenInfo();

                } catch (error) {
                    console.error('Withdraw error:', error);
                    messageDiv.innerHTML = '<div class="error">‚ùå L·ªói: ' + error.message + '</div>';
                }
            });

            // Approve functionality
            document.getElementById('approveBtn').addEventListener('click', async () => {
                const name = document.getElementById('approveName').value.trim();
                const address = document.getElementById('approveAddress').value.trim();
                const amount = document.getElementById('approveAmount').value.trim();
                const messageDiv = document.getElementById('approveMessage');

                if (!name || !address || !amount) {
                    messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!</div>';
                    return;
                }

                if (!ethers.utils.isAddress(address)) {
                    messageDiv.innerHTML = '<div class="error">‚ùå ƒê·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá!</div>';
                    return;
                }

                try {
                    messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang g·ª≠i giao d·ªãch approve...</div>';
                    
                    const amountWei = ethers.utils.parseEther(amount);
                    const tx = await contract.approve(address, amountWei);
                    
                    messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang ch·ªù x√°c nh·∫≠n...</div>';
                    await tx.wait();

                    approvedAddresses[address] = {
                        name: name,
                        amount: amount,
                        timestamp: Date.now()
                    };
                    saveApprovedAddresses();

                    messageDiv.innerHTML = '<div class="success">‚úÖ Ph√™ duy·ªát th√†nh c√¥ng! ' + amount + ' TMN cho ' + name + '</div>';
                    
                    document.getElementById('approveName').value = '';
                    document.getElementById('approveAddress').value = '';
                    document.getElementById('approveAmount').value = '';

                } catch (error) {
                    console.error('Approve error:', error);
                    messageDiv.innerHTML = '<div class="error">‚ùå L·ªói: ' + error.message + '</div>';
                }
            });

            // Revoke approval
            document.getElementById('revokeBtn').addEventListener('click', async () => {
                const address = document.getElementById('approveAddress').value.trim();
                const messageDiv = document.getElementById('approveMessage');

                if (!address) {
                    messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ c·∫ßn thu h·ªìi!</div>';
                    return;
                }

                if (!ethers.utils.isAddress(address)) {
                    messageDiv.innerHTML = '<div class="error">‚ùå ƒê·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá!</div>';
                    return;
                }

                try {
                    messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang thu h·ªìi ph√™ duy·ªát...</div>';
                    
                    const tx = await contract.approve(address, 0);
                    await tx.wait();

                    delete approvedAddresses[address];
                    saveApprovedAddresses();

                    messageDiv.innerHTML = '<div class="success">‚úÖ ƒê√£ thu h·ªìi ph√™ duy·ªát!</div>';
                    document.getElementById('approveAddress').value = '';

                } catch (error) {
                    console.error('Revoke error:', error);
                    messageDiv.innerHTML = '<div class="error">‚ùå L·ªói: ' + error.message + '</div>';
                }
            });

            // Transfer (from current account)
            document.getElementById('transferBtn').addEventListener('click', async () => {
                const to = document.getElementById('transferTo').value.trim();
                const amount = document.getElementById('transferAmount').value.trim();
                const messageDiv = document.getElementById('approveMessage');

                if (!to || !amount) {
                    messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ v√† s·ªë l∆∞·ª£ng!</div>';
                    return;
                }

                if (!ethers.utils.isAddress(to)) {
                    messageDiv.innerHTML = '<div class="error">‚ùå ƒê·ªãa ch·ªâ ng∆∞·ªùi nh·∫≠n kh√¥ng h·ª£p l·ªá!</div>';
                    return;
                }

                try {
                    messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang g·ª≠i transaction...</div>';
                    const amountWei = ethers.utils.parseEther(amount.toString());
                    const tx = await contract.connect(signer).transfer(to, amountWei);
                    await tx.wait();

                    messageDiv.innerHTML = `<div class="success">‚úÖ G·ª≠i ${amount} TMN t·ªõi ${to} th√†nh c√¥ng!</div>`;
                    document.getElementById('transferTo').value = '';
                    document.getElementById('transferAmount').value = '';

                    // Refresh UI
                    try { await displayApprovedList(); } catch (e) { /* ignore */ }
                    try { await displayWalletInfo(); } catch (e) { /* ignore */ }
                    try { document.getElementById('searchBtn').click(); } catch (e) { /* ignore */ }

                } catch (error) {
                    console.error('Transfer error:', error);
                    messageDiv.innerHTML = '<div class="error">‚ùå L·ªói g·ª≠i: ' + error.message + '</div>';
                }
            });

            // TransferFrom (current account acts as spender)
            document.getElementById('transferFromBtn').addEventListener('click', async () => {
                const owner = document.getElementById('tfFrom').value.trim();
                const to = document.getElementById('tfTo').value.trim();
                const amount = document.getElementById('tfAmount').value.trim();
                const messageDiv = document.getElementById('approveMessage');

                if (!owner || !to || !amount) {
                    messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß owner, to v√† s·ªë l∆∞·ª£ng!</div>';
                    return;
                }

                if (!ethers.utils.isAddress(owner) || !ethers.utils.isAddress(to)) {
                    messageDiv.innerHTML = '<div class="error">‚ùå M·ªôt trong c√°c ƒë·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá!</div>';
                    return;
                }

                try {
                    messageDiv.innerHTML = '<div class="loading">‚è≥ G·ªçi transferFrom...</div>';
                    const amountWei = ethers.utils.parseEther(amount.toString());
                    const tx = await contract.connect(signer).transferFrom(owner, to, amountWei);
                    await tx.wait();

                    messageDiv.innerHTML = `<div class="success">‚úÖ transferFrom th√†nh c√¥ng: ${amount} TMN t·ª´ ${owner} ‚Üí ${to}</div>`;
                    document.getElementById('tfFrom').value = '';
                    document.getElementById('tfTo').value = '';
                    document.getElementById('tfAmount').value = '';

                    // Refresh allowances and history
                    try { await displayApprovedList(); } catch (e) { /* ignore */ }
                    try { await displayWalletInfo(); } catch (e) { /* ignore */ }
                    try { document.getElementById('searchBtn').click(); } catch (e) { /* ignore */ }

                } catch (error) {
                    console.error('transferFrom error:', error);
                    messageDiv.innerHTML = '<div class="error">‚ùå L·ªói transferFrom: ' + error.message + '</div>';
                }
            });

            async function displayApprovedList() {
                const content = document.getElementById('approvedListContent');
                
                if (Object.keys(approvedAddresses).length === 0) {
                    content.innerHTML = '<div class="no-data">Ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o ƒë∆∞·ª£c ph√™ duy·ªát</div>';
                    return;
                }

                content.innerHTML = '<div class="loading">‚è≥ ƒêang t·∫£i...</div>';

                try {
                    const items = await Promise.all(
                        Object.entries(approvedAddresses).map(async ([address, data]) => {
                            // L·∫•y allowance hi·ªán t·∫°i
                            const currentAllowance = await contract.allowance(currentAccount, address);
                            const currentAllowanceFormatted = ethers.utils.formatEther(currentAllowance);
                            
                            // T√≠nh s·ªë ƒë√£ chi ti√™u
                            const approvedAmount = parseFloat(data.amount);
                            const remainingAmount = parseFloat(currentAllowanceFormatted);
                            const spentAmount = approvedAmount - remainingAmount;
                            const spentPercentage = ((spentAmount / approvedAmount) * 100).toFixed(1);

                            return `
                                <div class="approved-item">
                                    <div class="approved-header">
                                        <div class="approved-name">${data.name}</div>
                                        <div class="approved-amount">${remainingAmount.toFixed(2)} TMN c√≤n l·∫°i</div>
                                    </div>
                                    <div class="approved-address">${address}</div>
                                    
                                    <!-- Th√™m ph·∫ßn th·ªëng k√™ chi ti√™u -->
                                    <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                                            <div>
                                                <div style="font-size: 0.85em; color: #999;">ƒê√£ ph√™ duy·ªát</div>
                                                <div style="font-size: 1.2em; font-weight: bold; color: #667eea;">${approvedAmount.toFixed(2)} TMN</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 0.85em; color: #999;">ƒê√£ chi ti√™u</div>
                                                <div style="font-size: 1.2em; font-weight: bold; color: #e74c3c;">${spentAmount.toFixed(2)} TMN</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 0.85em; color: #999;">C√≤n l·∫°i</div>
                                                <div style="font-size: 1.2em; font-weight: bold; color: #27ae60;">${remainingAmount.toFixed(2)} TMN</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Progress bar -->
                                        <div style="margin-top: 10px;">
                                            <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #666; margin-bottom: 5px;">
                                                <span>Ti·∫øn ƒë·ªô chi ti√™u</span>
                                                <span>${spentPercentage}%</span>
                                            </div>
                                            <div style="height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                                <div style="height: 100%; width: ${spentPercentage}%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="font-size: 0.85em; color: #999; margin-top: 10px;">
                                        Ph√™ duy·ªát l√∫c: ${new Date(data.timestamp).toLocaleString('vi-VN')}
                                    </div>
                                    
                                    <!-- N√∫t h√†nh ƒë·ªông -->
                                    <div class="btn-group" style="margin-top: 15px;">
                                        <button class="btn btn-success" style="font-size: 0.9em; padding: 8px 20px;" onclick="reApprove('${address}', '${data.name}')">
                                            ‚ûï Ph√™ duy·ªát th√™m
                                        </button>
                                        <button class="btn btn-danger" style="font-size: 0.9em; padding: 8px 20px;" onclick="revokeApproval('${address}', '${data.name}')">
                                            ‚ùå Thu h·ªìi
                                        </button>
                                    </div>
                                </div>
                            `;
                        })
                    );

                    content.innerHTML = items.join('');

                } catch (error) {
                    console.error('Error loading approved list:', error);
                    content.innerHTML = '<div class="error">‚ùå L·ªói: ' + error.message + '</div>';
                }
            }

            // Search transaction history
            document.getElementById('searchBtn').addEventListener('click', async () => {
                let targetAddress = document.getElementById('searchAddress').value.trim();
                
                if (!targetAddress) {
                    targetAddress = currentAccount;
                }

                if (!ethers.utils.isAddress(targetAddress)) {
                    alert('‚ùå ƒê·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá!');
                    return;
                }

                await loadTransactionHistory(targetAddress);
            });

            async function loadTransactionHistory(address) {
                const historyContent = document.getElementById('historyContent');
                historyContent.innerHTML = '<div class="loading">‚è≥ ƒêang t·∫£i l·ªãch s·ª≠...</div>';

                try {
                    const transferFilter = contract.filters.Transfer();
                    const approvalFilter = contract.filters.Approval();
                    
                    const [transferEvents, approvalEvents] = await Promise.all([
                        contract.queryFilter(transferFilter, 0, 'latest'),
                        contract.queryFilter(approvalFilter, 0, 'latest')
                    ]);

                    const relevantTransfers = transferEvents.filter(event => 
                        event.args.from.toLowerCase() === address.toLowerCase() ||
                        event.args.to.toLowerCase() === address.toLowerCase()
                    );

                    const relevantApprovals = approvalEvents.filter(event =>
                        event.args.owner.toLowerCase() === address.toLowerCase()
                    );

                    if (relevantTransfers.length === 0 && relevantApprovals.length === 0) {
                        historyContent.innerHTML = '<div class="no-data">‚ùå Kh√¥ng c√≥ giao d·ªãch n√†o</div>';
                        document.getElementById('statsSection').style.display = 'none';
                        return;
                    }

                    const sentTxs = relevantTransfers.filter(tx => 
                        tx.args.from.toLowerCase() === address.toLowerCase()
                    );
                    const receivedTxs = relevantTransfers.filter(tx => 
                        tx.args.to.toLowerCase() === address.toLowerCase()
                    );

                    document.getElementById('totalTx').textContent = relevantTransfers.length + relevantApprovals.length;
                    document.getElementById('sentTx').textContent = sentTxs.length;
                    document.getElementById('receivedTx').textContent = receivedTxs.length;
                    document.getElementById('approvedTx').textContent = relevantApprovals.length;
                    document.getElementById('statsSection').style.display = 'grid';

                    // Combine and sort all events
                    const allEvents = [
                        ...relevantTransfers.map(e => ({...e, type: 'transfer'})),
                        ...relevantApprovals.map(e => ({...e, type: 'approval'}))
                    ].sort((a, b) => b.blockNumber - a.blockNumber);

                    const txsHtml = await Promise.all(
                        allEvents.map(async (event) => {
                            const block = await provider.getBlock(event.blockNumber);
                            const date = new Date(block.timestamp * 1000);

                            if (event.type === 'transfer') {
                                const isSent = event.args.from.toLowerCase() === address.toLowerCase();
                                const amount = ethers.utils.formatEther(event.args.value);
                                const txHash = event.transactionHash;
                                const metadata = txMetadata[txHash] || { note: '', tags: [] };

                                return `
                                    <div class="transaction ${isSent ? 'sent' : 'received'}" id="tx-${txHash}">
                                        <div class="tx-header">
                                            <span class="tx-type ${isSent ? 'sent' : 'received'}">
                                                ${isSent ? 'üì§ ƒê√£ g·ª≠i' : 'üì• ƒê√£ nh·∫≠n'}
                                            </span>
                                            <span class="tx-amount">${parseFloat(amount).toFixed(2)} TMN</span>
                                        </div>
                                        <div class="tx-details">
                                            <div><strong>T·ª´:</strong> ${event.args.from}</div>
                                            <div><strong>ƒê·∫øn:</strong> ${event.args.to}</div>
                                            <div><strong>Th·ªùi gian:</strong> ${date.toLocaleString('vi-VN')}</div>
                                            <div><strong>Block:</strong> ${event.blockNumber}</div>
                                            <div><strong>TX Hash:</strong> <span class="tx-hash" onclick="copyToClipboard('${txHash}')">${txHash}</span></div>
                                        </div>
                                        
                                        ${metadata.note ? `<div class="tx-note">üìù Ghi ch√∫: ${metadata.note}</div>` : ''}
                                        
                                        ${metadata.tags && metadata.tags.length > 0 ? `
                                            <div class="tx-tags">
                                                ${metadata.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        <div class="tx-actions">
                                            <button class="btn btn-small" onclick="addNote('${txHash}')">üìù Ghi ch√∫</button>
                                            <button class="btn btn-small" onclick="addTag('${txHash}')">üè∑Ô∏è Th√™m tag</button>
                                            <button class="btn btn-small btn-danger" onclick="deleteMetadata('${txHash}')">üóëÔ∏è X√≥a metadata</button>
                                        </div>
                                    </div>
                                `;
                            } else {
                                const amount = ethers.utils.formatEther(event.args.value);
                                const spenderName = approvedAddresses[event.args.spender] ? 
                                    approvedAddresses[event.args.spender].name : 'Kh√¥ng r√µ';

                                return `
                                    <div class="transaction approved">
                                        <div class="tx-header">
                                            <span class="tx-type approved">
                                                üîê ƒê√£ ph√™ duy·ªát
                                            </span>
                                            <span class="tx-amount">${parseFloat(amount).toFixed(2)} TMN</span>
                                        </div>
                                        <div class="tx-details">
                                            <div><strong>Ng∆∞·ªùi ph√™ duy·ªát:</strong> ${event.args.owner}</div>
                                            <div><strong>Ng∆∞·ªùi ƒë∆∞·ª£c ph√™ duy·ªát:</strong> ${event.args.spender}</div>
                                            <div><strong>T√™n:</strong> ${spenderName}</div>
                                            <div><strong>Th·ªùi gian:</strong> ${date.toLocaleString('vi-VN')}</div>
                                            <div><strong>Block:</strong> ${event.blockNumber}</div>
                                            <div><strong>TX Hash:</strong> <span class="tx-hash" onclick="copyToClipboard('${event.transactionHash}')">${event.transactionHash}</span></div>
                                        </div>
                                    </div>
                                `;
                            }
                        })
                    );
                    

                    historyContent.innerHTML = txsHtml.join('');

                } catch (error) {
                    console.error('Error loading history:', error);
                    historyContent.innerHTML = `<div class="error">‚ùå L·ªói: ${error.message}</div>`;
                }
            }

            window.copyToClipboard = function(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('‚úÖ ƒê√£ copy: ' + text);
                }).catch(err => {
                    console.error('Copy error:', err);
                    alert('‚ùå Kh√¥ng th·ªÉ copy');
                });
            }

            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        location.reload();
                    }
                });

                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });
            }
        });

        // Re-approve function
        window.reApprove = async function(address, name) {
            const amount = prompt(`Nh·∫≠p s·ªë l∆∞·ª£ng token mu·ªën ph√™ duy·ªát th√™m cho ${name}:`, '1000');
            if (!amount) return;
            
            try {
                const amountWei = ethers.utils.parseEther(amount);
                
                // L·∫•y allowance hi·ªán t·∫°i
                const currentAllowance = await contract.allowance(currentAccount, address);
                const newAllowance = currentAllowance.add(amountWei);
                
                const tx = await contract.approve(address, newAllowance);
                alert('‚è≥ ƒêang x·ª≠ l√Ω...');
                await tx.wait();
                
                // C·∫≠p nh·∫≠t storage
                const currentData = approvedAddresses[address];
                const newTotal = parseFloat(ethers.utils.formatEther(newAllowance));
                approvedAddresses[address] = {
                    ...currentData,
                    amount: newTotal.toString()
                };
                saveApprovedAddresses();
                
                alert('‚úÖ ƒê√£ ph√™ duy·ªát th√™m th√†nh c√¥ng!');
                displayApprovedList();
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // Revoke approval function
        window.revokeApproval = async function(address, name) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën thu h·ªìi ph√™ duy·ªát cho ${name}?`)) return;
            
            try {
                const tx = await contract.approve(address, 0);
                alert('‚è≥ ƒêang x·ª≠ l√Ω...');
                await tx.wait();
                
                delete approvedAddresses[address];
                saveApprovedAddresses();
                
                alert('‚úÖ ƒê√£ thu h·ªìi ph√™ duy·ªát!');
                displayApprovedList();
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // Th√™m ghi ch√∫ cho transaction
        window.addNote = function(txHash) {
            try {
                if (!currentAccount) {
                    alert('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!');
                    return;
                }
                
                const currentNote = txMetadata[txHash]?.note || '';
                const note = prompt('Nh·∫≠p ghi ch√∫ cho giao d·ªãch n√†y:', currentNote);
                
                if (note === null) return; // User cancelled
                
                if (!txMetadata[txHash]) {
                    txMetadata[txHash] = { note: '', tags: [] };
                }
                
                txMetadata[txHash].note = note.trim();
                saveTxMetadata();
                
                // Refresh display
                document.getElementById('searchBtn').click();
                
                if (note.trim()) {
                    alert('‚úÖ ƒê√£ l∆∞u ghi ch√∫!');
                }
            } catch (error) {
                console.error('Add note error:', error);
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // Th√™m tag cho transaction
        window.addTag = function(txHash) {
            try {
                if (!currentAccount) {
                    alert('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!');
                    return;
                }
                
                const tag = prompt('Nh·∫≠p tag (VD: l∆∞∆°ng, ti·ªÅn thu√™, ƒë·∫ßu t∆∞):');
                
                if (!tag || tag.trim() === '') return;
                
                const cleanTag = tag.trim();
                
                if (!txMetadata[txHash]) {
                    txMetadata[txHash] = { note: '', tags: [] };
                }
                
                if (!txMetadata[txHash].tags.includes(cleanTag)) {
                    txMetadata[txHash].tags.push(cleanTag);
                    saveTxMetadata();
                    
                    // Refresh display
                    document.getElementById('searchBtn').click();
                    alert('‚úÖ ƒê√£ th√™m tag: ' + cleanTag);
                } else {
                    alert('‚ö†Ô∏è Tag n√†y ƒë√£ t·ªìn t·∫°i!');
                }
            } catch (error) {
                console.error('Add tag error:', error);
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // X√≥a metadata
        window.deleteMetadata = function(txHash) {
            try {
                if (!currentAccount) {
                    alert('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!');
                    return;
                }
                
                if (!confirm('X√≥a t·∫•t c·∫£ ghi ch√∫ v√† tag c·ªßa giao d·ªãch n√†y?')) return;
                
                delete txMetadata[txHash];
                saveTxMetadata();
                
                // Refresh display
                document.getElementById('searchBtn').click();
                alert('‚úÖ ƒê√£ x√≥a metadata!');
            } catch (error) {
                console.error('Delete metadata error:', error);
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // Filter by tag (th√™m t√≠nh nƒÉng l·ªçc)
        window.filterByTag = function() {
            try {
                const tag = prompt('Nh·∫≠p tag ƒë·ªÉ l·ªçc (ƒë·ªÉ tr·ªëng ƒë·ªÉ hi·ªán t·∫•t c·∫£):');
                
                const allTx = document.querySelectorAll('.transaction');
                
                // If no tag provided, show all
                if (!tag || tag.trim() === '') {
                    allTx.forEach(tx => tx.style.display = 'block');
                    return;
                }
                
                // Filter by tag
                allTx.forEach(tx => {
                    const tags = tx.querySelector('.tx-tags');
                    if (tags && tags.textContent.toLowerCase().includes('#' + tag.toLowerCase())) {
                        tx.style.display = 'block';
                    } else {
                        tx.style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('Filter error:', error);
                alert('‚ùå L·ªói l·ªçc: ' + error.message);
            }
        }

        // Export history to CSV
        window.exportHistory = async function() {
            try {
                // Check if connected
                if (!currentAccount || !provider || !contract) {
                    alert('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!');
                    return;
                }
                
                const address = document.getElementById('searchAddress').value.trim() || currentAccount;
                
                if (!ethers.utils.isAddress(address)) {
                    alert('‚ùå ƒê·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá!');
                    return;
                }
                
                // Show loading message
                const originalText = event.target?.textContent;
                if (event.target) event.target.textContent = '‚è≥ ƒêang xu·∫•t...';
                
                const transferFilter = contract.filters.Transfer();
                const events = await contract.queryFilter(transferFilter, 0, 'latest');
                
                const relevantTxs = events.filter(event => 
                    event.args.from.toLowerCase() === address.toLowerCase() ||
                    event.args.to.toLowerCase() === address.toLowerCase()
                );
                
                if (relevantTxs.length === 0) {
                    alert('‚ö†Ô∏è Kh√¥ng c√≥ giao d·ªãch n√†o ƒë·ªÉ xu·∫•t!');
                    if (event.target) event.target.textContent = originalText;
                    return;
                }
                
                let csv = 'Th·ªùi gian,Lo·∫°i,T·ª´,ƒê·∫øn,S·ªë l∆∞·ª£ng (TMN),TX Hash,Ghi ch√∫,Tags\n';
                
                for (const txEvent of relevantTxs) {
                    const block = await provider.getBlock(txEvent.blockNumber);
                    const date = new Date(block.timestamp * 1000).toLocaleString('vi-VN');
                    const isSent = txEvent.args.from.toLowerCase() === address.toLowerCase();
                    const type = isSent ? 'G·ª≠i' : 'Nh·∫≠n';
                    const amount = ethers.utils.formatEther(txEvent.args.value);
                    const metadata = txMetadata[txEvent.transactionHash] || { note: '', tags: [] };
                    
                    csv += `"${date}","${type}","${txEvent.args.from}","${txEvent.args.to}","${amount}","${txEvent.transactionHash}","${metadata.note}","${metadata.tags.join(', ')}"\n`;
                }
                
                // Download CSV with UTF-8 BOM for Excel compatibility
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `TMN_history_${address.substring(0, 8)}_${Date.now()}.csv`;
                link.click();
                
                // Cleanup
                URL.revokeObjectURL(link.href);
                if (event.target) event.target.textContent = originalText;
                
                alert(`‚úÖ ƒê√£ xu·∫•t ${relevantTxs.length} giao d·ªãch th√†nh c√¥ng!`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå L·ªói xu·∫•t CSV: ' + error.message);
            }
        }

        // ========== NFT FUNCTIONALITY ==========
        
        async function loadNFTInfo() {
            if (!window.nftContract || !window.currentAccount) {
                console.log('NFT contract or account not initialized yet');
                return;
            }
            
            try {
                const name = await window.nftContract.name();
                const symbol = await window.nftContract.symbol();
                const totalSupply = await window.nftContract.totalSupply();
                const userBalance = await window.nftContract.balanceOf(window.currentAccount);

                document.getElementById('nftContractName').textContent = name;
                document.getElementById('nftSymbol').textContent = symbol;
                document.getElementById('nftTotalSupply').textContent = totalSupply.toString() + ' NFTs';
                document.getElementById('nftUserBalance').textContent = userBalance.toString() + ' NFTs';

                await displayNFTGallery();
            } catch (error) {
                console.error('Error loading NFT info:', error);
            }
        }

        async function displayNFTGallery() {
            const gallery = document.getElementById('nftGallery');
            
            if (!window.nftContract || !window.currentAccount) {
                gallery.innerHTML = '<div class="no-data">Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc</div>';
                return;
            }
            
            try {
                const tokenIds = await window.nftContract.tokensOfOwner(window.currentAccount);
                
                if (tokenIds.length === 0) {
                    gallery.innerHTML = '<div class="no-data">B·∫°n ch∆∞a c√≥ NFT n√†o</div>';
                    return;
                }

                gallery.innerHTML = '<div class="loading">‚è≥ ƒêang t·∫£i NFTs...</div>';

                const nfts = await Promise.all(
                    tokenIds.map(async (tokenId) => {
                        try {
                            const metadata = await window.nftContract.getMetadata(tokenId);
                            const tokenURI = await window.nftContract.tokenURI(tokenId);
                            
                            // Parse token URI if it's a data URI [v2.0-FIXED]
                            let imageData = '';
                            if (tokenURI.startsWith('data:application/json;base64,')) {
                                // Get everything after "data:application/json;base64," prefix
                                const base64Data = tokenURI.substring(tokenURI.indexOf(',') + 1);
                                const jsonStr = atob(base64Data);
                                console.log(`[v2.0] Token #${tokenId} decoded JSON:`, jsonStr.substring(0, 100));
                                const jsonData = JSON.parse(jsonStr);
                                imageData = jsonData.image || '';
                            }

                            return {
                                tokenId: tokenId.toString(),
                                name: metadata.name,
                                description: metadata.description,
                                imageData: imageData,
                                mintedAt: new Date(metadata.mintedAt.toNumber() * 1000).toLocaleString('vi-VN')
                            };
                        } catch (error) {
                            console.error(`Error loading NFT ${tokenId}:`, error);
                            return null;
                        }
                    })
                );

                const validNfts = nfts.filter(nft => nft !== null);

                if (validNfts.length === 0) {
                    // If we have tokenIds but all failed to load, show error
                    if (tokenIds.length > 0) {
                        gallery.innerHTML = '<div class="error">‚ùå Kh√¥ng th·ªÉ t·∫£i metadata NFT. Vui l√≤ng ki·ªÉm tra console ƒë·ªÉ bi·∫øt chi ti·∫øt.</div>';
                    } else {
                        gallery.innerHTML = '<div class="no-data">B·∫°n ch∆∞a c√≥ NFT n√†o</div>';
                    }
                    return;
                }

                gallery.innerHTML = '<div class="nft-gallery">' + validNfts.map(nft => `
                    <div class="nft-card">
                        ${nft.imageData ? `<img src="${nft.imageData}" class="nft-image" alt="${nft.name}">` : '<div class="nft-image"></div>'}
                        <div class="nft-info">
                            <div class="nft-token-id">Token #${nft.tokenId}</div>
                            <div class="nft-name">${nft.name}</div>
                            <div class="nft-description">${nft.description}</div>
                            <div style="font-size: 0.85em; color: #999;">
                                Minted: ${nft.mintedAt}
                            </div>
                            <div class="nft-actions">
                                <button class="btn btn-success" onclick="quickTransferNFT('${nft.tokenId}')">
                                    üì§ Transfer
                                </button>
                                <button class="btn" onclick="importNFTToMetaMask('${nft.tokenId}')">
                                    üì≤ Import
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('') + '</div>';

            } catch (error) {
                console.error('Error displaying NFT gallery:', error);
                gallery.innerHTML = '<div class="error">‚ùå L·ªói t·∫£i gallery: ' + error.message + '</div>';
            }
        }

        // Mint NFT Button
        document.getElementById('mintNFTBtn').addEventListener('click', async () => {
            const name = document.getElementById('nftName').value.trim();
            const description = document.getElementById('nftDescription').value.trim();
            let mintTo = document.getElementById('nftMintTo').value.trim();
            const messageDiv = document.getElementById('nftMintMessage');

            // Check if wallet is connected
            if (!window.nftContract) {
                messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!</div>';
                return;
            }

            if (!name || !description) {
                messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng nh·∫≠p t√™n v√† m√¥ t·∫£!</div>';
                return;
            }

            if (!mintTo) {
                mintTo = window.currentAccount;
            } else if (!ethers.utils.isAddress(mintTo)) {
                messageDiv.innerHTML = '<div class="error">‚ùå ƒê·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá!</div>';
                return;
            }

            try {
                messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang mint NFT...</div>';
                
                const tx = await window.nftContract.mintSimpleNFT(mintTo, name, description);
                messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang ch·ªù x√°c nh·∫≠n...</div>';
                const receipt = await tx.wait();

                // Get token ID from event
                const event = receipt.events?.find(e => e.event === 'NFTMinted');
                const tokenId = event ? event.args.tokenId.toString() : 'N/A';

                messageDiv.innerHTML = `<div class="success">‚úÖ Mint th√†nh c√¥ng NFT #${tokenId}!</div>`;
                
                document.getElementById('nftName').value = '';
                document.getElementById('nftDescription').value = '';
                document.getElementById('nftMintTo').value = '';

                await loadNFTInfo();

            } catch (error) {
                console.error('Mint error:', error);
                messageDiv.innerHTML = '<div class="error">‚ùå L·ªói: ' + error.message + '</div>';
            }
        });

        // Refresh NFT Button
        document.getElementById('refreshNFTBtn').addEventListener('click', async () => {
            await loadNFTInfo();
        });

        // Transfer NFT Button
        document.getElementById('transferNFTBtn').addEventListener('click', async () => {
            const tokenId = document.getElementById('nftTransferTokenId').value.trim();
            const to = document.getElementById('nftTransferTo').value.trim();
            const messageDiv = document.getElementById('nftTransferMessage');

            if (!window.nftContract) {
                messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!</div>';
                return;
            }

            if (!tokenId || !to) {
                messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng nh·∫≠p Token ID v√† ƒë·ªãa ch·ªâ!</div>';
                return;
            }

            if (!ethers.utils.isAddress(to)) {
                messageDiv.innerHTML = '<div class="error">‚ùå ƒê·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá!</div>';
                return;
            }

            try {
                messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang transfer NFT...</div>';
                
                const tx = await window.nftContract.safeTransferFrom(window.currentAccount, to, tokenId);
                messageDiv.innerHTML = '<div class="loading">‚è≥ ƒêang ch·ªù x√°c nh·∫≠n...</div>';
                await tx.wait();

                messageDiv.innerHTML = `<div class="success">‚úÖ Transfer NFT #${tokenId} th√†nh c√¥ng t·ªõi ${to}!</div>`;
                
                document.getElementById('nftTransferTokenId').value = '';
                document.getElementById('nftTransferTo').value = '';

                await loadNFTInfo();

            } catch (error) {
                console.error('Transfer error:', error);
                messageDiv.innerHTML = '<div class="error">‚ùå L·ªói: ' + error.message + '</div>';
            }
        });

        // Import NFT to MetaMask Button
        document.getElementById('importNFTBtn').addEventListener('click', async () => {
            const tokenId = document.getElementById('nftImportTokenId').value.trim();
            const messageDiv = document.getElementById('nftImportMessage');

            if (!tokenId) {
                messageDiv.innerHTML = '<div class="error">‚ùå Vui l√≤ng nh·∫≠p Token ID!</div>';
                return;
            }

            await importNFTToMetaMask(tokenId, messageDiv);
        });

        // Helper function to import NFT to MetaMask
        async function importNFTToMetaMask(tokenId, messageDiv = null) {
            const msg = messageDiv || document.getElementById('nftImportMessage');
            
            if (!window.nftContract) {
                msg.innerHTML = '<div class="error">‚ùå Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!</div>';
                return;
            }
            
            try {
                // Check if token exists
                const owner = await window.nftContract.ownerOf(tokenId);
                
                msg.innerHTML = '<div class="loading">‚è≥ ƒêang import v√†o MetaMask...</div>';

                const wasAdded = await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC721',
                        options: {
                            address: NFT_CONTRACT_ADDRESS,
                            tokenId: tokenId,
                        },
                    },
                });

                if (wasAdded) {
                    msg.innerHTML = '<div class="success">‚úÖ ƒê√£ import NFT #' + tokenId + ' v√†o MetaMask!</div>';
                } else {
                    msg.innerHTML = '<div class="error">‚ö†Ô∏è Import b·ªã h·ªßy ho·∫∑c th·∫•t b·∫°i</div>';
                }

            } catch (error) {
                console.error('Import error:', error);
                msg.innerHTML = '<div class="error">‚ùå L·ªói: ' + error.message + '</div>';
            }
        }

        // Quick transfer from gallery
        window.quickTransferNFT = async function(tokenId) {
            if (!window.nftContract) {
                alert('‚ùå Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!');
                return;
            }

            const to = prompt('Nh·∫≠p ƒë·ªãa ch·ªâ ng∆∞·ªùi nh·∫≠n:');
            if (!to) return;

            if (!ethers.utils.isAddress(to)) {
                alert('‚ùå ƒê·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá!');
                return;
            }

            try {
                const tx = await window.nftContract.safeTransferFrom(window.currentAccount, to, tokenId);
                alert('‚è≥ ƒêang ch·ªù x√°c nh·∫≠n...');
                await tx.wait();
                
                alert(`‚úÖ Transfer NFT #${tokenId} th√†nh c√¥ng!`);
                await loadNFTInfo();
                
            } catch (error) {
                console.error('Transfer error:', error);
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // Make importNFTToMetaMask globally accessible
        window.importNFTToMetaMask = importNFTToMetaMask;

    </script>
</body>
</html>